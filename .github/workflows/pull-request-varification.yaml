name: Pull Request Verification
defaults:
  run:
    # 明示的にshellを指定すると "pipefail"が暗黙的に設定され安全性が向上する
    shell: bash
on:
  pull_request:
concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  # 新しい変更を検知した際、すでに実行中のジョブはキャンセルする (プルリクのテストは最新のコードベースだけ検証したいため)
  cancel-in-progress: true
jobs:
  linter-formatter:
    runs-on: ubuntu-latest
    steps:
      - name: "checkout"
        uses: actions/checkout@v6

      - name: "setup java"
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: '21'

      - name: "setup gradle"
        uses: gradle/actions/setup-gradle@v5

      - name: "./gradleファイルを実行する権限を付与"
        run: chmod +x ./gradlew

      - name: "ktlint"
        run: ./gradlew ktlintCheck

  unit-test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: "checkout"
        uses: actions/checkout@v6

      - name: "setup java"
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: '21'

      - name: "setup gradle"
        uses: gradle/actions/setup-gradle@v5

      - name: "./gradleファイルを実行する権限を付与"
        run: chmod +x ./gradlew

      - name: "test & カバレッジ測定"
        run: ./gradlew :inaba-service:jacocoTestReport

      - name: "testカバレッジをプルリクエストに書き込む"
        id: jacoco
        uses: madrapps/jacoco-report@v1.7.2
        with:
          paths: |
            ${{ github.workspace }}/inaba-service/build/reports/jacoco/test/jacocoTestReport.xml,
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          min-coverage-changed-files: 80
          pass-emoji: ✅